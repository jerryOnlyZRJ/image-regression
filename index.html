<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>åˆ©ç”¨å·ç§¯ç¥ç»ç½‘ç»œç®—æ³•è¯†åˆ«è½¦logo</title>
</head>

<body>
    <img src="http://p.pstatp.com/avatar/100x100/1dd5000018fab5bd782b.png" id="some_image" crossorigin="anonymous" />
    <input type="button" value="è¯†åˆ«" id="test" />
    <script src="./net/car.js"></script>
    <script src="./net/convnet.js"></script>
    <script>
        //ç¥ç»ç½‘ç»œ
        let layer_defs = [];
        // è¾“å…¥å±‚ï¼šå³æ˜¯100*100*3çš„å›¾åƒ
        layer_defs.push({ type: 'input', out_sx: 100, out_sy: 100, out_depth: 3 });
        // å·ç§¯å±‚ 
        // filterï¼šç”¨16ä¸ª5*5çš„æ»¤æ³¢å™¨å»å·ç§¯
        // strideï¼šå·ç§¯æ­¥é•¿ä¸º1
        // paddingï¼šå¡«å……å®½åº¦ä¸º2ï¼ˆä¸ºä¿è¯è¾“å‡ºçš„å›¾åƒå¤§å°ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼‰
        // activationï¼šæ¿€æ´»å‡½æ•°ä¸ºreluï¼ˆè¿˜æœ‰Tanhã€Sigmoidç­‰ç­‰å‡½æ•°ï¼ŒåŠŸèƒ½ä¸åŒï¼‰
        layer_defs.push({ type: 'conv', sx: 5, filters: 16, stride: 1, pad: 2, activation: 'relu' });
        // æ± åŒ–å±‚
        // æ± åŒ–æ»¤æ³¢å™¨çš„å¤§å°ä¸º2*2
        // strideï¼šæ­¥é•¿ä¸º2
        // åœ¨è¿™é‡Œæˆ‘ä»¬æ— æ³•çœ‹å‡ºè¿™ä¸ªæ¡†æ¶æ± åŒ–æ˜¯ä½¿ç”¨çš„Avy Poolingè¿˜æ˜¯Max Poolingç®—æ³•ï¼Œå…ˆè§†ä¸ºåè€…
        layer_defs.push({ type: 'pool', sx: 2, stride: 2 });
        // åå¤å·ç§¯å’Œæ± åŒ–å‡å°æ¨¡å‹è¯¯å·®
        layer_defs.push({ type: 'conv', sx: 5, filters: 20, stride: 1, pad: 2, activation: 'relu' });
        layer_defs.push({ type: 'pool', sx: 2, stride: 2 });
        layer_defs.push({ type: 'conv', sx: 5, filters: 20, stride: 1, pad: 2, activation: 'relu' });
        layer_defs.push({ type: 'pool', sx: 2, stride: 2 });
        // åˆ†ç±»å™¨ï¼šè¾“å‡º10ä¸­ä¸åŒçš„ç±»åˆ«
        layer_defs.push({ type: 'softmax', num_classes: 10 });
        // åˆå§‹åŒ–ç¥ç»ç½‘è·¯
        const net = new convnetjs.Net();
        net.makeLayers(layer_defs);
        // åˆå§‹åŒ–è®­ç»ƒæœºåˆ¶
        const trainer = new convnetjs.SGDTrainer(net, { learning_rate: 0.01, momentum: 0.9, batch_size: 5, l2_decay: 0.0 });
        let imageList = [];
        const loadData = i => {
            return function () {
                return new Promise(function (resolve, reject) {
                    let image = new Image();
                    image.crossOrigin = "anonymous";
                    image.src = carList[i].url;
                    image.onload = function () {
                        let vol = convnetjs.img_to_vol(image);
                        trainer.train(vol, i);
                        resolve();
                    };
                    image.onerror = reject;
                })
            }
        }
        for (let j = 0; j < carList.length; j++) {
            imageList.push(loadData(j));
        }
        var testBtn = document.getElementById("test")
        function training(){
            testBtn.disabled = true
            return new Promise((resolve, reject) => {
                Promise.all(imageList.map(imageContainer => imageContainer())).then(() => {
                    console.log("æ¨¡å‹è®­ç»ƒå¥½äº†ï¼ï¼ï¼ğŸ‘Œ")
                    testBtn.disabled = false
                    resolve()
                })
            })
        }
        training().then(() => {
            testBtn.addEventListener('click', () => {
                // å‘Šè¯‰æœºå™¨æ¯ä¸€ç±»å¯¹åº”çš„æ˜¯ä»€ä¹ˆï¼ˆå³è®©æœºå™¨è®¤è¯†å›¾ç‰‡çš„è¿‡ç¨‹ï¼‰
                const carNameList = ["å¥¥è¿ª", "å¥”é©°", "å®é©¬", "æœ¬ç”°", "åˆ«å…‹", "æ¯”äºšè¿ª", "ä¿æ—¶æ·", "å¤§ä¼—", "å“ˆå¼—"];
                const x = convnetjs.img_to_vol(document.getElementById('some_image'));
                console.log(net.forward(x),x);
                const result = Array.from(net.forward(x).w);
                let max = Math.max.apply(Math, result);
                console.log("æœ€æœ‰å¯èƒ½çš„é‚£ä¸ªæ±½è½¦logoğŸš—", carNameList[result.indexOf(max)])
                console.log("æ¥ç€è®­ç»ƒï¼ï¼ï¼ğŸ’ª")
                training()
            })
        })
    </script>
</body>

</html>